---
# Copyright (c) 2024 Oracle and/or its affiliates.
# This software is made available to you under the terms of the Universal Permissive License (UPL), Version 1.0.
# The Universal Permissive License (UPL), Version 1.0 (see COPYING or https://oss.oracle.com/licenses/upl)
# See LICENSE.TXT for details.

- name: Gather load balancer information
  block:

  - name: Get load balancer ip address
    ansible.builtin.shell: |
      oci lb load-balancer list --auth instance_principal --compartment-id {{ compartment_ocid }} | jq -r '.data[]."ip-addresses"[]."ip-address"'
    register: command_output
    become_user: "{{ username }}"
  
  - name: Set load balancer ip address
    ansible.builtin.set_fact:
      lb_ip: "{{ command_output.stdout }}"
  
  - name: Print load balancer ip address
    ansible.builtin.debug:
      msg: "{{ lb_ip }}"
    when: debug_enabled
  
  when: use_lb    

- name: Create file myenvironment.yaml
  ansible.builtin.template:
    src: myenvironment.j2
    dest: ~/myenvironment.yaml
  become_user: "{{ username }}"

- name: Create environment
  ansible.builtin.shell: |
    olcnectl environment create --config-file myenvironment.yaml
  args:
    chdir: ~/
  become_user: "{{ username }}"

- name: Create/Validate Kubernetes Module
  ansible.builtin.shell: |
    olcnectl module create --config-file myenvironment.yaml
    olcnectl module validate --config-file myenvironment.yaml
  args:
    chdir: ~/
  become_user: "{{ username }}"

- name: Install Kubernetes Module
  ansible.builtin.shell: |
    olcnectl module install --config-file myenvironment.yaml
  args:
    chdir: ~/
  become_user: "{{ username }}"
  register: provision_kubernetes

- name: Print kubernetes provision output
  ansible.builtin.debug:
    var: provision_kubernetes
  when: debug_enabled

- name: Tag OCNE as provisioned
  ansible.builtin.file:
    path: ~/.ocne-provisioned
    state: touch
  become_user: "{{ username }}"
  when: provision_kubernetes.rc == 0
