---
# Copyright (c) 2024 Oracle and/or its affiliates.
# This software is made available to you under the terms of the Universal Permissive License (UPL), Version 1.0.
# The Universal Permissive License (UPL), Version 1.0 (see COPYING or https://oss.oracle.com/licenses/upl)
# See LICENSE.TXT for details.

- name: Install VNC Server and GNOME Desktop
  hosts: vbox
  vars_files:
    - default_vars.yml
  become: true

  tasks:

  - name: Install required packages for virtualbox
    ansible.builtin.dnf:
      name:
        - "kernel-uek-devel-{{ ansible_kernel }}"
        - gcc
        - make
        - perl
      state: latest

  - name: Add virtualbox repo keys
    ansible.builtin.rpm_key:
      state: present
      key: https://www.virtualbox.org/download/oracle_vbox_2016.asc

  - name: Add virtualbox repo
    ansible.builtin.yum_repository:
      name: virtualbox
      description: Oracle VirtualBox
      baseurl: http://download.virtualbox.org/virtualbox/rpm/el/$releasever/$basearch

  - name: "Install virtualbox version {{ virtualbox_version }}"
    ansible.builtin.dnf:
      name: "VirtualBox-{{ virtualbox_version }}"
      state: latest

  - name: Check if extension pack is already installed
    ansible.builtin.shell: "vboxmanage list extpacks"
    register: extpack_list

  - name: Output installed extpacks
    ansible.builtin.debug:
      var: extpack_list.stdout
      verbosity: 1

  - name: Download virtualbox extension pack
    ansible.builtin.get_url:
      url: 'https://download.virtualbox.org/virtualbox/{{ virtualbox_extpack_version }}/Oracle_VirtualBox_Extension_Pack-{{ virtualbox_extpack_version }}.vbox-extpack'
      dest: /tmp/
      force: yes
    register: download_result
    when: 'extpack_list.stdout == "Extension Packs: 0"'

  - name: Output download virtualbox extension pack file name
    ansible.builtin.debug:
      var: download_result.dest
      verbosity: 1

  - name: Install virtualbox extension pack
    ansible.builtin.shell: "echo 'y' |  vboxmanage extpack install --replace {{ download_result.dest }}"
    when: 'extpack_list.stdout == "Extension Packs: 0"'

  - name: Download the Oracle Linux iso file
    ansible.builtin.get_url:
      url: 'https://yum.oracle.com/ISOS/OracleLinux/OL{{ ol_version }}/u{{ ol_update }}/x86_64/OracleLinux-R{{ ol_version }}-U{{ ol_update }}-x86_64-dvd.iso'  
      dest: /home/{{ username }}
      force: yes
    register: download_iso_result
    until: "'OK' in download_iso_result.msg"
    retries: 5
    delay: 10
